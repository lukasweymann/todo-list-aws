pipeline {
    agent any
    options {
        timestamps()
        disableConcurrentBuilds()
    }

    environment {
        // Production identifiers
        PROD_STACK = 'todo-list-aws-production'
        BASE_URL_OUTPUT_KEY = 'BaseUrlApi'
        AWS_REGION = 'us-east-1'
    }

    stages {
        stage('Get Code') {
            agent any
            steps {
                sh '''
                  set -e
                  echo "=== NODE INFO (Get Code) ==="
                  whoami
                  hostname
                '''
                checkout scm
                sh '''
                  set -e
                  echo "Descargando samconfig.toml desde repo de config (branch: staging)..."
                  curl -fsSL -o samconfig.toml \
                  https://raw.githubusercontent.com/lukasweymann/todo-list-aws-config/staging/samconfig.toml
                  echo "samconfig.toml descargado:"
                  head -n 30 samconfig.toml
                  echo "Branch: $BRANCH_NAME"
                  git rev-parse --short HEAD
                  test -d src
                '''
            }
        }

        stage('Deploy') {
            agent any
            steps {
                sh '''
                  set -e
                  echo "=== NODE INFO (Deploy) ==="
                  whoami
                  hostname

                  sam --version
                  aws --version

                  echo "Validando..."
                  sam validate --region "$AWS_REGION"

                  echo "Construyendo..."
                  sam build

                  echo "Desplegando a production (samconfig.toml)..."
                  sam deploy \
                    --config-env production \
                    --resolve-s3 \
                    --no-confirm-changeset \
                    --no-fail-on-empty-changeset

                       mkdir -p env

                  BASE_URL=$(aws cloudformation describe-stacks \
                  --stack-name todo-list-aws-staging \
                  --region us-east-1 \
                  --query "Stacks[0].Outputs[?OutputKey=='BaseUrlApi'].OutputValue" \
                  --output text)

                  if [ -z "$BASE_URL" ] || [ "$BASE_URL" = "None" ]; then
                  echo "ERROR: could not read BASE_URL"
                  exit 1
                  fi

                  echo "$BASE_URL" > env/BASE_URL.txt
                  echo "Saved BASE_URL=$BASE_URL"
                  ls -R .
                '''
                stash name: 'envdata', includes: 'env/**'
            }
        }

        stage('Rest Test (Read-only)') {
            agent { label 'rest-agent' }
            steps {
                unstash 'envdata'

                sh '''
                  set -e
                  echo "=== NODE INFO (Rest Test - Read-only) ==="
                  whoami
                  hostname

                  echo "Workspace content:"
                  ls -R .

                  BASE_URL=$(cat env/BASE_URL.txt)
                  export BASE_URL="$BASE_URL"
                  echo "BASE_URL=$BASE_URL"

                  echo "Tests de integraci√≥n (solo lectura) con pytest..."
                  echo "Ejecutando: pytest -vv -m read test/integration/todoApiTest.py"
                  pytest -vv -m read test/integration/todoApiTest.py
                '''
            }
        }
    }
}
