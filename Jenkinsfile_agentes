pipeline {
    agent any
    options {
        timestamps()
        disableConcurrentBuilds()
    }

    environment {
        AWS_REGION = 'us-east-1'
        // Credenciales de github del entorno de Jenkins
        GIT_WRITE_CRED_ID = 'github-pat-write'
        // key de cloud formation para poder hacer pytest
        BASE_URL_OUTPUT_KEY = 'ApiUrl'
    }

    stages {
        stage('Get Code') {
            agent any
            steps {
                sh '''
                  set -e
                  echo "=== NODE INFO (Get Code) ==="
                  whoami
                  hostname
                '''
                checkout scm
                sh 'echo "Branch: $BRANCH_NAME"'
                sh 'git rev-parse --short HEAD'
                sh 'test -d src'
            }
        }

        stage('Static Test ') {
            agent { label 'static-agent' }
            steps {
                sh '''
          set -e
          echo "=== NODE INFO (Static Test) ==="
          whoami
          hostname

          set +e

          mkdir -p reports

          echo "Tests con flake8 sólo en directorio src como indicado"
          flake8 src --count --statistics --exit-zero | tee reports/flake8.txt

          echo "Tests con bandit..."
          bandit -r src -f txt -o reports/bandit.txt || true
        '''
                archiveArtifacts artifacts: 'reports/*', fingerprint: true
            }
        }

        stage('Deploy (SAM) - Staging') {
            agent any
            steps {
                sh '''
      set -e
      echo "=== NODE INFO (Deploy - Staging) ==="
      whoami
      hostname

      sam --version
      aws --version

      echo "Validando..."
      sam validate --region "$AWS_REGION"

      echo "Construyendo con sam..."
      sam build

      echo "Deploy using samconfig.toml (staging env)..."
      sam deploy --config-env staging  --resolve-s3\
      --no-confirm-changeset \
      --no-fail-on-empty-changeset

      mkdir -p env
      BASE_URL=$(aws cloudformation describe-stacks \
        --stack-name todo-list-aws-staging \
        --region us-east-1 \
        --query "Stacks[0].Outputs[?OutputKey=='BaseUrlApi'].OutputValue" \
        --output text)

      if [ -z "$BASE_URL" ] || [ "$BASE_URL" = "None" ]; then
        echo "ERROR: could not read BASE_URL from CloudFormation."
        exit 1
      fi

      echo "$BASE_URL" > env/BASE_URL.txt
      echo "Saved BASE_URL: $BASE_URL"
    '''
                stash name: 'envdata', includes: 'env/BASE_URL.txt'
            }
        }

        stage('Rest Test') {
            agent { label 'rest-agent' }
            steps {
                sh '''
          set -e
          echo "=== NODE INFO (Rest Test) ==="
          whoami
          hostname

          BASE_URL=$(cat env/BASE_URL.txt)
      export BASE_URL="$BASE_URL"
      echo "BASE_URL=$BASE_URL"

          # Haciendo la URL accesible para pytest
          export BASE_URL="$BASE_URL"

          echo "Ejecutando tests de integración...: pytest -vv test/integration/todoApiTest.py"
          pytest -vv test/integration/todoApiTest.py
        '''
            }
        }

        stage('Promote') {
            when { branch 'develop' }
            agent any
            steps {
                sh '''
          set -e
          echo "=== NODE INFO (Promote) ==="
          whoami
          hostname

          echo "Release build marker" > RELEASE.txt
          echo "Commit: $(git rev-parse HEAD)" >> RELEASE.txt
          date -Is >> RELEASE.txt
        '''
                archiveArtifacts artifacts: 'RELEASE.txt', fingerprint: true

                // Merge develop -> master + push (requires write credential)
                withCredentials([usernamePassword(
          credentialsId: "${GIT_WRITE_CRED_ID}",
          usernameVariable: 'GH_USER',
          passwordVariable: 'GH_TOKEN'
        )]) {
                    sh '''
            set -e
            # (same node as Promote stage)
            git config user.email "ci-bot@example.com"
            git config user.name "ci-bot"

            git fetch origin --prune '+refs/heads/*:refs/remotes/origin/*'

            # Asegurar que el merge se haga con el commit en concreto para evitar inconsistencia
            TESTED_COMMIT=$(git rev-parse HEAD)

            git checkout master
            git reset --hard origin/master

            # Mergeo de la rama develop a master
            git merge --no-ff "$TESTED_COMMIT" -m "Promote: release from develop ($TESTED_COMMIT)"

            # Subir cambios sin exponer datos sensibles en echo
            git push "https://${GH_USER}:${GH_TOKEN}@github.com/lukasweymann/todo-list-aws.git" master
          '''
        }
            }
        }
    }
}
